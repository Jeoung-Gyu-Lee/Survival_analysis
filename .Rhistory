assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"))
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
View(plot_surv)
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"))
plot_surv$plot  <- plot_surv$plot  +
theme(axis.title = element_text(size = 12, face="bold"),
axis.text  = element_text(size = 10),
legend.text= element_text(size = 10))
plot_surv$table <- plot_surv$table +
theme(axis.text.x = element_text(size = 10),
axis.text.y = element_text(size = 10))
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D")) +
theme(axis.title = element_text(size = 12, face="bold"),
axis.text  = element_text(size = 10),
legend.text= element_text(size = 10),
axis.text.x = element_text(size = 10),
axis.text.y = element_text(size = 10))
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"),
ggtheme = theme_classic(base_size = 13),
font.x = c(12, "bold"),
font.y = c(12, "bold"),
font.tickslab = 10,
risk.table.fontsize = 3.4)
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"),
ggtheme = theme_classic(base_size = 14),
font.x = c(14),
font.y = c(14),
font.tickslab = 12,
risk.table.fontsize = 5.4)
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"),
ggtheme = theme_classic(base_size = 15),
font.x = c(16),
font.y = c(16),
font.tickslab = 13,
risk.table.fontsize = 5.4)
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"),
ggtheme = theme_classic(base_size = 15),
font.x = c(18),
font.y = c(18),
font.tickslab = 13,
risk.table.fontsize = 5.4)
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"),
ggtheme = theme_classic(base_size = 15),
font.x = c(16),
font.y = c(16),
font.tickslab = 13,
risk.table.fontsize = 5.4)
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
for (g in target_genes) {
dat_g <- subset(target_meta, gene_name == g)
# Fitting the Curve
fit <- survfit(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Log-rank test and extract p-value for annotation to KM plot
logrank <- survdiff(formula = Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
pval <- paste0("logrank P = ",
signif(1 - pchisq(logrank$chisq, length(logrank$n) - 1), 3))
# Cox regression: Univariate analysis
cox_uni <- coxph(Surv(Overall_survival, Vital_status) ~ exp_group, data = dat_g)
# Save results in Global Env
assign(paste0("logrank_", g), logrank, envir = .GlobalEnv)
assign(paste0("cox_", g), cox_uni, envir = .GlobalEnv)
# Extract HR ratio for annotation to KM plot
HR <- paste0("HR = ",
round(summary(cox_uni)$coefficients[,"exp(coef)"], 2), " (",
round(summary(cox_uni)$conf.int[,"lower .95"], 2), " - ",
round(summary(cox_uni)$conf.int[,"upper .95"], 2), ")")
# KM plot and saving the pdf files and annotation
plot_surv <- ggsurvplot(fit,
data = dat_g,
xlab = "Time (years)",
pval = F,
risk.table = T,
legend.title = "",
legend.labs = c(paste0(g, "_LOW"), paste0(g, "_HIGH")),
palette = c("#00BFC4", "#F8766D"),
ggtheme = theme_classic(base_size = 15),
font.x = c(15),
font.y = c(15),
font.tickslab = 15,
risk.table.fontsize = 5.4)
pdf(file.path(result_dir, paste0("KM_plot_", g, ".pdf")), width = 9, height = 8)
plot_surv$plot <- plot_surv$plot +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.95,
label = pval,
size = 5,
hjust = 0) +
ggplot2::annotate("text",
x = max(dat_g$Overall_survival, na.rm = TRUE) * 0.75,
y = 0.88,
label = HR,
size = 5,
hjust = 0)
print(plot_surv)
dev.off()
}
# Clinical data in wide format
clin_cols <- c("Overall_survival","Vital_status","Gender","Age","Stage", "Smoking","M_stage","N_stage","T_stage")
clin_wide <- target_meta %>%
select(all_of(c("case_id", clin_cols))) %>%
distinct(case_id, .keep_all = TRUE)
# Expression data in wide format
expr_wide <- target_meta %>%
select(case_id, gene_name, counts) %>%
pivot_wider(names_from = gene_name, values_from = counts)
# Merge Clinical data + Expression data by case_id
cox_df <- clin_wide %>% inner_join(expr_wide, by = "case_id")
rownames(cox_df) <- cox_df$case_id
# Build formula for multivariate Cox model (continuous expression values)
form_genes <- as.formula(paste0("Surv(Overall_survival, Vital_status) ~ ", paste(target_genes, collapse = " + ")))
# Fit the multivariate Cox model
cox_multi <- coxph(form_genes, data = cox_df, x = TRUE)
summary(cox_multi)
form_risk <- as.formula(
"Surv(Overall_survival, Vital_status) ~ Risk_score + Gender + Age + Stage + Smoking + M_stage + N_stage + T_stage")
# Fit Cox model including risk score and routine clinical variables
cox_clinic <- coxph(form_risk, data=cox_df, x=TRUE)
# Calculate Risk Score from β coefficients (recommended: standardize as z-score)
betas <- coef(cox_multi)[target_genes]
Risk_score <- as.numeric(as.matrix(cox_df[, target_genes, drop=FALSE]) %*% betas)
cox_df$Risk_score <- as.numeric(scale(Risk_score))  # z-score
form_risk <- as.formula(
"Surv(Overall_survival, Vital_status) ~ Risk_score + Gender + Age + Stage + Smoking + M_stage + N_stage + T_stage")
# Fit Cox model including risk score and routine clinical variables
cox_clinic <- coxph(form_risk, data=cox_df, x=TRUE)
summary(cox_clinic)
pdf(file.path(result_dir, "FOREST.pdf"), width = 9, height = 8)
p <- ggforest(
cox_clinic,
data      = model.frame(cox_clinic),
fontsize  = 1.2,                  # ← 글자 20% 키우기
main      = "Hazard ratio",
refLabel  = "reference",
noDigits  = 2
)
print(p)
dev.off()
pdf(file.path(result_dir, "FOREST.pdf"), width = 11, height = 9)
p <- ggforest(
cox_clinic,
data      = model.frame(cox_clinic),
fontsize  = 1.2,                  # ← 글자 20% 키우기
main      = "Hazard ratio",
refLabel  = "reference",
noDigits  = 2
)
print(p)
dev.off()
pdf(file.path(result_dir, "FOREST.pdf"), width = 11, height = 11)
p <- ggforest(
cox_clinic,
data      = model.frame(cox_clinic),
fontsize  = 1.2,                  # ← 글자 20% 키우기
main      = "Hazard ratio",
refLabel  = "reference",
noDigits  = 2
)
print(p)
dev.off()
pdf(file.path(result_dir, "FOREST.pdf"), width = 11, height = 13)
p <- ggforest(
cox_clinic,
data      = model.frame(cox_clinic),
fontsize  = 1.2,                  # ← 글자 20% 키우기
main      = "Hazard ratio",
refLabel  = "reference",
noDigits  = 2
)
print(p)
dev.off()
pdf(file.path(result_dir, "FOREST.pdf"), width = 11, height = 13)
p <- ggforest(
cox_clinic,
data      = model.frame(cox_clinic),
fontsize  = 1.3,                  # ← 글자 20% 키우기
main      = "Hazard ratio",
refLabel  = "reference",
noDigits  = 2
)
print(p)
dev.off()
